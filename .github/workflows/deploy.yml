name: CI/CD to GCP

on:
  push:
    branches:
      - main  # mainブランチへのPushをトリガーとする

# 環境変数 (GitHub Secretsで設定した値を参照)
env:
  # GCP/Cloud Runの設定
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_ID: accounting-api
  AR_REPO: tutorial-myapp # Artifact Registryリポジトリ名
  IMAGE: accounting-app
  # Cloud SQL接続名
  SQL_CONN: ${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:tutorial-myapp-database-setting

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Workload Identity連携に必要な権限
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. コードのチェックアウト
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. GCP認証 (Workload Identity連携)
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # 3. Docker認証 (Artifact Registryへのプッシュ準備)
      - name: Set up Docker access to AR
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      # 4. バックエンド: ビルドとプッシュ
      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE }}:${{ github.sha }}
          docker build --platform linux/amd64 -t $IMAGE_TAG .
          docker push $IMAGE_TAG
        
      # 5. バックエンド: Cloud Runデプロイ（Secret ManagerからDBパスワードを注入）
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_ID }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE }}:${{ github.sha }}
          flags: |
            --set-secrets DB_PASS=DB_PASSWORD:latest
            --add-cloudsql-instances ${{ env.SQL_CONN }}
            --set-env-vars DB_USER=${{ env.DB_USER }},DB_NAME=${{ env.DB_NAME }}

      # 6. フロントエンド: Node.js環境セットアップ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          cache: 'npm' 

      - name: Install Dependencies
        run: npm install


      # 7. フロントエンド: ビルドと公開
      # 以前のアクションを削除し、新しいステップを追加
      - name: Deploy Frontend to Firebase Hosting
        run: |
          # 1. Firebase CLIをインストール (次のステップで必要)
          npm install -g firebase-tools
          
          # 2. Firebaseにログイン (WIF認証情報を使うため、トークンは不要)
          # GCloud認証情報（ステップ2で作成）が自動的に使われる
          firebase use --add ${{ env.PROJECT_ID }} --token "${{ secrets.GITHUB_TOKEN }}"
          
          # 3. Hostingへデプロイ実行
          # firebaseServiceAccountは不要。GCP認証が自動で借用される。
          firebase deploy --only hosting --project ${{ env.PROJECT_ID }}
        env:
          # Firebase CLIがGitHub Actions内で動作するために必要な環境変数
          # WIF認証で得たクレデンシャルが自動的に使われます
          FIREBASE_CLI_PREVIEWS: hostingchannels
        

  