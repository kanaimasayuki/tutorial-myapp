name: CI/CD to GCP

on:
  push:
    branches:
      - main  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®Pushã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã™ã‚‹

# ç’°å¢ƒå¤‰æ•° (GitHub Secretsã§è¨­å®šã—ãŸå€¤ã‚’å‚ç…§)
env:
  # GCP/Cloud Runã®è¨­å®š
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SERVICE_ID: accounting-api
  AR_REPO: tutorial-myapp # Artifact Registryãƒªãƒã‚¸ãƒˆãƒªå
  IMAGE: accounting-app
  # Cloud SQLæ¥ç¶šå
  SQL_CONN: ${{ secrets.GCP_PROJECT_ID }}:${{ secrets.GCP_REGION }}:tutorial-myapp-database-setting

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # Workload Identityé€£æºã«å¿…è¦ãªæ¨©é™
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. GCPèªè¨¼ (Workload Identityé€£æº)
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      # 3. Dockerèªè¨¼ (Artifact Registryã¸ã®ãƒ—ãƒƒã‚·ãƒ¥æº–å‚™)
      - name: Set up Docker access to AR
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev

      # 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥
      - name: Build and Push Docker Image
        run: |
          IMAGE_TAG=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE }}:${{ github.sha }}
          docker build --platform linux/amd64 -t $IMAGE_TAG .
          docker push $IMAGE_TAG
        
      # 5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: Cloud Runãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆSecret Managerã‹ã‚‰DBãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ³¨å…¥ï¼‰
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_ID }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.AR_REPO }}/${{ env.IMAGE }}:${{ github.sha }}
          flags: |
            --allow-unauthenticated
            --set-secrets DB_PASS=3968_Kokusho
            --add-cloudsql-instances ${{ env.SQL_CONN }}
            --set-env-vars DB_USER=${{ secrets.DB_USER }},DB_NAME=${{ secrets.DB_NAME }},SQL_CONN=${{ env.SQL_CONN }}
      
      # 6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: Node.jsç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
          cache: 'npm' 

      - name: Install Dependencies
        run: npm install


      # 7. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: ãƒ“ãƒ«ãƒ‰ã¨å…¬é–‹
      # ä»¥å‰ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã—ã€æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
      - name: Deploy Frontend to Firebase Hosting
        # ğŸ’¡ run ãƒ–ãƒ­ãƒƒã‚¯ã‚’ä¿®æ­£ã—ã€èªè¨¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æ¸¡ã™
        run: |
          # 1. Firebase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          npm install -g firebase-tools
          
          # 2. Next.jsã‚’ãƒ“ãƒ«ãƒ‰
          npm run build
          ls -F
          
          # 3. Hostingã¸ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ (FIREBASE_TOKENç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨)
          # --token ãƒ•ãƒ©ã‚°ã‚’ä½¿ã„ã€WIFã§å–å¾—ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¸¡ã—ã¾ã™ã€‚
          firebase deploy --only hosting --project ${{ env.PROJECT_ID }} --token "${{ steps.auth.outputs.access_token }}"
        env:
          # Firebase CLIãŒGitHub Actionså†…ã§å‹•ä½œã™ã‚‹ãŸã‚ã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°.
          # WIFèªè¨¼ã§å¾—ãŸã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ãŒè‡ªå‹•çš„ã«ä½¿ã‚ã‚Œã¾ã™
          FIREBASE_CLI_PREVIEWS: hostingchannels
        

  

  